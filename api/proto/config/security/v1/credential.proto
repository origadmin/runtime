syntax = "proto3";

package runtime.api.config.security.v1;

import "config/security/authn/apikey/v1/credential.proto";
import "config/security/authn/basic/v1/credential.proto";
import "config/security/authn/oidc/v1/credential.proto";
import "gnostic/openapi/v3/annotations.proto";
import "google/protobuf/any.proto";
import "google/protobuf/struct.proto"; // Import struct.proto for Value
import "validate/validate.proto";

option go_package = "github.com/origadmin/runtime/api/gen/go/config/security/v1;securityv1";

// Payload is a union of structured credential types, primarily for use in
// CredentialResponse.
message Payload {
  // Basic authentication credential.
  optional runtime.api.config.security.authn.basic.v1.BasicCredential basic = 10 [
    json_name = "basic",
    (gnostic.openapi.v3.property) = {description: "Basic authentication credential."}
  ];

  // API Key or Preshared Key credential.
  optional runtime.api.config.security.authn.apikey.v1.KeyCredential key = 11 [
    json_name = "key",
    (gnostic.openapi.v3.property) = {description: "API Key or Preshared Key credential."}
  ];

  // OIDC credential.
  optional runtime.api.config.security.authn.oidc.v1.OidcCredential oidc = 12 [
    json_name = "oidc",
    (gnostic.openapi.v3.property) = {description: "OIDC credential."}
  ];

  // Token-based credential (JWT, OAuth2).
  // IMPORTANT: This structure is designed for OUTPUT (e.g., in CredentialResponse)
  // after a token has been successfully issued.
  optional TokenCredential token = 13 [
    json_name = "token",
    (gnostic.openapi.v3.property) = {description: "Token-based credential (JWT, OAuth2), primarily for responses."}
  ];

  // Raw serialized data for unsupported credential types.
  optional string raw_data = 14 [
    json_name = "rawData",
    (gnostic.openapi.v3.property) = {description: "Raw serialized data for unsupported credential types."}
  ];
}

// MetaValue is a wrapper for multi-value metadata entries, designed to
// losslessly and type-safely represent transport-layer metadata like HTTP headers.
message MetaValue {
  repeated string values = 1;
}

// CredentialSource is a generic container for transmitting credential data.
// It follows a "dumb pipe" philosophy, where it acts as a simple, unopinionated
// container for the raw credential data extracted from a request. The responsibility
// of parsing and interpreting the data lies solely with the consumer (the Authenticator).
message CredentialSource {
  // Type indicates the kind of credential, e.g., "bearer", "basic", "apikey".
  // This serves as a hint to the Authenticator on how to interpret the data.
  string type = 1 [
    json_name = "type",
    (gnostic.openapi.v3.property) = {description: "A hint indicating the credential type (e.g., 'bearer', 'basic')."}
  ];

  // Raw contains the original, unmodified credential string extracted from the request
  // (e.g., the full content of the `Authorization` header).
  // This field MUST be treated as the authoritative source of truth by any Authenticator.
  string raw = 2 [
    json_name = "raw",
    (gnostic.openapi.v3.property) = {description: "The original, unmodified credential string. This is the authoritative source of truth."}
  ];

  // Payload serves as an OPTIONAL, pre-parsed cache for the `raw` field to improve
  // ease of use for consumers.
  //
  // Filling Rules:
  // - CredentialExtractor SHOULD identify common credential patterns (e.g., "Bearer <token>")
  //   and pack a corresponding well-known type (e.g., `BearerCredential`) into this field.
  //
  // Usage Rules:
  // - Authenticator SHOULD first attempt to unpack a known type from this field.
  //   If successful, it can use the structured data directly, avoiding reparsing.
  //   If it fails or the field is empty, it MUST fall back to parsing the `raw` field.
  google.protobuf.Any payload = 3 [
    json_name = "payload",
    (gnostic.openapi.v3.property) = {description: "Optional pre-parsed cache of the credential, for ease of use. Consumers must fallback to `raw`."}
  ];

  // Meta contains additional, non-credential data extracted from the request
  // (e.g., from headers) that may be relevant for authentication/authorization decisions.
  // The CredentialExtractor MUST support configurable mapping from request metadata
  // (e.g., HTTP headers which are map[string][]string) to this field.
  map<string, MetaValue> meta = 4 [
    json_name = "meta",
    (gnostic.openapi.v3.property) = {description: "Configurable auxiliary data from the request context, perfectly representing multi-value headers."}
  ];
}

// CredentialResponse represents a credential structure intended for
// transmission to clients (e.g., frontend applications) after a successful
// authentication or token issuance event.
message CredentialResponse {
  // Type indicates the kind of credential being returned, e.g., "jwt", "apikey".
  string type = 1 [
    json_name = "type",
    (gnostic.openapi.v3.property) = {description: "Type of the credential being returned (e.g., 'jwt', 'apikey')."}
  ];

  // Payload contains the structured data of the issued credential.
  Payload payload = 2 [
    json_name = "payload",
    (gnostic.openapi.v3.property) = {description: "The structured data of the issued credential."}
  ];

  // Optional metadata to be sent to the client.
  map<string, google.protobuf.Value> meta = 4 [
    json_name = "meta",
    (gnostic.openapi.v3.property) = {description: "Optional metadata to be sent to the client."}
  ];
}

// BearerCredential represents the structured payload for a "Bearer" scheme credential.
// It is a well-known type intended to be packed into the `google.protobuf.Any`
// `payload` field of a `CredentialSource` message.
message BearerCredential {
  // The token string, without the "Bearer " prefix.
  string token = 1 [
    (gnostic.openapi.v3.property) = {description: "The token string, without the 'Bearer ' prefix."}
  ];
}

// TokenCredential holds the credentials for token-based authentication flows
// like OAuth2 and JWT.
//
// IMPORTANT: This message represents the full set of tokens typically returned
// from a token issuance endpoint (e.g., /login). It is designed for use in
// CredentialResponse.
message TokenCredential {
  // The access token used for authentication.
  string access_token = 1 [
    json_name = "accessToken",
    (validate.rules).string.min_len = 1,
    (gnostic.openapi.v3.property) = {description: "The access token used for authentication."}
  ];

  // The refresh token used to obtain a new access token.
  string refresh_token = 2 [
    json_name = "refreshToken",
    (gnostic.openapi.v3.property) = {description: "The refresh token used to obtain a new access token."}
  ];

  // The remaining lifetime of the access token in seconds.
  int64 expires_in = 3 [
    json_name = "expiresIn",
    (gnostic.openapi.v3.property) = {description: "The remaining lifetime of the access token in seconds."}
  ];

  // The type of the token, typically "Bearer".
  string token_type = 4 [
    json_name = "tokenType",
    (gnostic.openapi.v3.property) = {description: "The type of the token, typically 'Bearer'."}
  ];
}
