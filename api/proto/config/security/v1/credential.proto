syntax = "proto3";

package runtime.api.config.security.v1;

import "config/security/authn/apikey/v1/credential.proto";
import "config/security/authn/basic/v1/credential.proto";
import "config/security/authn/oidc/v1/credential.proto";
import "gnostic/openapi/v3/annotations.proto";
import "google/protobuf/any.proto";
import "google/protobuf/struct.proto"; // Import struct.proto for Value
import "validate/validate.proto";

option go_package = "github.com/origadmin/runtime/api/gen/go/config/security/v1;securityv1";

// Payload is a union of structured credential types.
// It serves as an optional, pre-parsed cache for the `raw` credential string.
//
// USAGE GUIDELINES:
// - When used as an input for authentication (e.g., in CredentialSource),
//   it should only be populated by a CredentialExtractor if the credential
//   type is simple and safe to parse at the extraction stage (e.g., Basic Auth).
//   For complex types like JWTs, parsing and validation are the Authenticator's
//   responsibility, and this field should typically be left empty on input.
// - It is primarily intended for use within CredentialResponse, where full
//   credential details are being sent to a client after successful issuance.
message Payload {
  // Basic authentication credential.
  optional runtime.api.config.security.authn.basic.v1.BasicCredential basic = 10 [
    json_name = "basic",
    (gnostic.openapi.v3.property) = {description: "Basic authentication credential."}
  ];

  // API Key or Preshared Key credential.
  optional runtime.api.config.security.authn.apikey.v1.KeyCredential key = 11 [
    json_name = "key",
    (gnostic.openapi.v3.property) = {description: "API Key or Preshared Key credential."}
  ];

  // OIDC credential.
  optional runtime.api.config.security.authn.oidc.v1.OidcCredential oidc = 12 [
    json_name = "oidc",
    (gnostic.openapi.v3.property) = {description: "OIDC credential."}
  ];

  // Token-based credential (JWT, OAuth2).
  // IMPORTANT: This structure is designed for OUTPUT (e.g., in CredentialResponse)
  // after a token has been successfully issued. It is NOT suitable as an INPUT
  // for authenticating a request, as only the access token is typically provided.
  optional TokenCredential token = 13 [
    json_name = "token",
    (gnostic.openapi.v3.property) = {description: "Token-based credential (JWT, OAuth2), primarily for responses."}
  ];

  // Raw serialized data for unsupported credential types.
  optional string raw_data = 14 [
    json_name = "rawData",
    (gnostic.openapi.v3.property) = {description: "Raw serialized data for unsupported credential types."}
  ];
}

// CredentialSource is a generic container for transmitting credential data, typically
// from a client or gateway to an authentication service. It serves as the primary
// data structure for the `declarative.Credential` Go interface when sent over the wire.
//
// FIELD FILLING PRIORITY AND RULES:
// 1. `raw` field: MUST be the primary source of truth for the credential string.
// 2. `payload` field: OPTIONAL pre-parsed cache. Authenticator MUST NOT blindly trust it.
// 3. `meta` field: Configurable auxiliary data.
message CredentialSource {
  // Type indicates the kind of credential, e.g., "jwt", "apikey", "basic".
  // This helps the receiving service understand how to interpret the raw data or payload.
  string type = 1 [
    json_name = "type",
    (gnostic.openapi.v3.property) = {description: "Type of the credential (e.g., 'jwt', 'apikey')."}
  ];

  // Raw contains the original, unparsed credential string.
  // For token-based auth (e.g., JWT Bearer token), this field MUST contain the full token string.
  // For API keys, it MUST contain the key string.
  // The Authenticator MUST treat this field as the primary source of truth for validation.
  string raw = 2 [
    json_name = "raw",
    (gnostic.openapi.v3.property) = {description: "Original, unparsed credential string, primary source of truth for validation."}
  ];

  // Payload optionally contains a structured representation of the credential.
  // It serves as an OPTIONAL pre-parsed cache for the `raw` field.
  //
  // Filling Rules:
  // - CredentialExtractor MAY populate this field by packing a well-known type
  //   (e.g., `BearerCredential` or `authn.basic.v1.BasicCredential`) into this Any field.
  //   This is recommended for common, simple credential types.
  //
  // Usage Rules:
  // - Authenticator MAY use this field if present, but MUST be prepared to fall back
  //   to parsing the `raw` field if `payload` is empty or untrusted.
  google.protobuf.Any payload = 3 [
    json_name = "payload",
    (gnostic.openapi.v3.property) = {description: "Optional pre-parsed cache of the credential, not to be blindly trusted. Recommended to pack well-known types like BearerCredential."}
  ];

  // Meta contains additional, non-core data about the credential or the request context.
  //
  // Filling Rules:
  // - CredentialExtractor MUST support configurable extraction of metadata from the
  //   ValueProvider (original request) and populate this field (e.g., by mapping
  //   specific request headers like `X-Credential-Meta-Foo` to `meta["foo"]`).
  // - Intermediate components in the authentication/authorization chain MAY also
  //   add contextual information to this field (e.g., validation method, issuer details).
  //
  // Usage Rules:
  // - Authenticator or Authorizer MAY read auxiliary information from this field
  //   for fine-grained decisions or auditing purposes.
  map<string, google.protobuf.Any> meta = 4 [
    json_name = "meta",
    (gnostic.openapi.v3.property) = {description: "Configurable auxiliary data about the credential or request context."}
  ];
}

// CredentialResponse represents a credential structure intended for
// transmission to clients (e.g., frontend applications) after a successful
// authentication or token issuance event. It contains processed and
// safe-to-expose credential information.
message CredentialResponse {
  // Type indicates the kind of credential, e.g., "jwt", "apikey", "basic".
  // This helps the receiving client understand how to interpret the payload.
  string type = 1 [
    json_name = "type",
    (gnostic.openapi.v3.property) = {description: "Type of the credential (e.g., 'jwt', 'apikey')."}
  ];

  // Payload contains the credential data, which is a union of all possible
  // credential types. The client should use the 'type' field to determine
  // which specific credential data to use.
  Payload payload = 2 [
    json_name = "payload",
    (gnostic.openapi.v3.property) = {description: "Credential data, which is a union of all possible credential types."}
  ];

  // Optional metadata of the credential, using google.protobuf.Value for
  // more direct JSON serialization.
  map<string, google.protobuf.Value> meta = 4 [
    json_name = "meta",
    (gnostic.openapi.v3.property) = {description: "Optional metadata of the credential."}
  ];
}

// BearerCredential represents the payload for a "Bearer" scheme credential.
// It is a well-known type intended to be packed into the `google.protobuf.Any`
// field of a `CredentialSource` message when the credential type is "bearer".
message BearerCredential {
  // The token string, without the "Bearer " prefix.
  string token = 1 [
    (gnostic.openapi.v3.property) = {description: "The token string, without the 'Bearer ' prefix."}
  ];
}

// TokenCredential holds the credentials for token-based authentication flows
// like OAuth2 and JWT.
//
// IMPORTANT: This message represents the full set of tokens typically returned
// from a token issuance endpoint (e.g., /login). It is designed for use in
// CredentialResponse and is NOT suitable as an input for authenticating a
// request, as an incoming request typically only provides a single access token.
message TokenCredential {
  // The access token used for authentication.
  string access_token = 1 [
    json_name = "accessToken",
    (validate.rules).string.min_len = 1,
    (gnostic.openapi.v3.property) = {description: "The access token used for authentication."}
  ];

  // The refresh token used to obtain a new access token.
  string refresh_token = 2 [
    json_name = "refreshToken",
    (gnostic.openapi.v3.property) = {description: "The refresh token used to obtain a new access token."}
  ];

  // The remaining lifetime of the access token in seconds.
  int64 expires_in = 3 [
    json_name = "expiresIn",
    (gnostic.openapi.v3.property) = {description: "The remaining lifetime of the access token in seconds."}
  ];

  // The type of the token, typically "Bearer".
  string token_type = 4 [
    json_name = "tokenType",
    (gnostic.openapi.v3.property) = {description: "The type of the token, typically 'Bearer'."}
  ];
}
